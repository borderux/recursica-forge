# Deploy Workflow with Changesets
#
# Purpose: Manages versioning, releases, and GitHub Pages deployments using Changesets.
#
# This workflow handles the complete release lifecycle:
# 1. Version Management: When changesets are present, creates a "Version Packages" PR
# 2. Release Creation: When the version PR is merged, creates git tags and GitHub releases
# 3. Deployment: After a release is created, deploys the application to GitHub Pages
#
# How it works:
# 1. Builds the application (verifies compilation in version mode, prepares for deployment in publish mode)
# 2. Runs Changesets Action which operates in two modes:
#    - Version mode (changesets exist): Creates a "Version Packages" pull request with version bumps and changelog
#    - Publish mode (no changesets): Runs `npm run release` which executes `changeset publish` to:
#      * Create a git tag for the release version
#      * Create a GitHub release with changelog (using @changesets/changelog-github)
#      * Set the `published` output to `true` when successful
# 3. If publishing occurred (`published == true`), deploys the built application to GitHub Pages
#
# This workflow runs on every push to main and can be manually triggered via workflow_dispatch.
# The Changesets Action automatically determines which mode to use based on the presence of changeset files.

name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

concurrency:
  group: github-pages
  cancel-in-progress: false

jobs:
  changesets:
    name: Version, Release, and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci
        env:
          HUSKY: 0

      # Build the application
      # Always builds to:
      # - Verify compilation succeeds before creating version PR (version mode)
      # - Prepare the production build for deployment (publish mode)
      - name: Build
        run: npm run build
        env:
          VITE_RECURSICA_API_URL: ${{ vars.VITE_RECURSICA_API_URL }}
          VITE_RECURSICA_UI_URL: ${{ vars.VITE_RECURSICA_UI_URL }}
          VITE_PLUGIN_PHRASE: ${{ secrets.PLUGIN_PHRASE }}

      # Changesets Action - The Core of Our Release System
      #
      # This action automatically operates in one of two modes:
      #
      # Version Mode (changesets exist):
      # - Creates a "Version Packages" pull request
      # - The PR includes version bumps in package.json and updated CHANGELOG.md
      # - After the PR is merged, the workflow runs again in publish mode
      #
      # Publish Mode (no changesets, version PR was merged):
      # - Runs the `publish` command: `npm run release`
      # - Which executes: `changeset publish`
      # - This creates:
      #   * A git tag for the release version (e.g., v1.2.3)
      #   * A GitHub release with changelog (using @changesets/changelog-github for PR/commit links)
      #   * Sets the `published` output to `true` when successful
      #
      # Note: Since this package is marked `private: true` in package.json, it won't publish to npm.
      - name: Create Release Pull Request or Publish
        id: changesets-action
        uses: changesets/action@v1
        with:
          publish: npm run release
        env:
          GITHUB_TOKEN: ${{ secrets.CHANGESETS_RELEASE_PAT }}

      # Deploy to GitHub Pages (only after a release is created)
      #
      # These steps only run when the Changesets Action successfully published a release
      # (i.e., `steps.changesets-action.outputs.published == 'true'`).
      # This ensures we only deploy after:
      # 1. The version PR has been merged
      # 2. A git tag and GitHub release have been created
      # 3. The release is ready for deployment
      #
      # Configure GitHub Pages deployment settings
      - name: Setup Pages
        if: steps.changesets-action.outputs.published == 'true'
        uses: actions/configure-pages@v4

      # Upload the built dist folder as a Pages artifact
      # The build from earlier in the workflow is reused here
      - name: Upload artifact
        if: steps.changesets-action.outputs.published == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

      # Deploy the uploaded artifact to GitHub Pages
      # Makes the application available at the repository's GitHub Pages URL
      - name: Deploy to GitHub Pages
        if: steps.changesets-action.outputs.published == 'true'
        id: deployment
        uses: actions/deploy-pages@v4
